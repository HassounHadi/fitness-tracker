"use client";

import { useState, useEffect } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ExerciseFormItem } from "@/components/exercises/exercise-form-item";
import { ExerciseDetailsDisplay } from "@/components/exercises/exercise-details-display";
import { SectionHeader } from "@/components/common/section-header";
import {
  useStartWorkout,
  useUpdateSet,
  useCompleteWorkout,
  type WorkoutLog,
} from "@/hooks/use-workout-log";
import { Loader2 } from "lucide-react";

// Type for Exercise from WorkoutLog
interface Exercise {
  id: string;
  name: string;
  target: string;
  apiId: string;
  gifUrl: string;
  bodyPart: string;
  equipment: string;
  secondaryMuscles: string[];
  instructions: string[];
  createdAt: Date;
  updatedAt: Date;
}

// -------------------- Active Workout Page --------------------
export default function ActiveWorkoutPage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const scheduledWorkoutId = searchParams.get("scheduledWorkoutId");

  const [workoutLog, setWorkoutLog] = useState<WorkoutLog | null>(null);
  const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
  const [currentSetIndex, setCurrentSetIndex] = useState(0);
  const [logDialogOpen, setLogDialogOpen] = useState(false);
  const [workoutStartTime, setWorkoutStartTime] = useState<Date | null>(null);
  const [hasStarted, setHasStarted] = useState(false);

  const startWorkoutMutation = useStartWorkout();
  const updateSetMutation = useUpdateSet();
  const completeWorkoutMutation = useCompleteWorkout();

  // Start the workout when component mounts - single useEffect
  useEffect(() => {
    if (scheduledWorkoutId && !hasStarted) {
      setHasStarted(true);
      startWorkoutMutation.mutate(
        { scheduledWorkoutId },
        {
          onSuccess: (data) => {
            console.log("Workout started successfully:", data);
            setWorkoutLog(data ?? null);
            if (data) setWorkoutStartTime(new Date());
          },
          onError: (error) => {
            console.error("Failed to start workout:", error);
            router.push("/calendar");
          },
        }
      );
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [scheduledWorkoutId]);

  // Use template exercises for UI, logged exercises for tracking completion
  const templateExercises = workoutLog?.templateExercises || [];
  const loggedExercises = workoutLog?.exercises || [];

  const currentTemplateExercise = templateExercises[currentExerciseIndex];
  const currentLoggedExercise = loggedExercises.find(
    (ex) => ex.exerciseId === currentTemplateExercise?.exerciseId
  );
  const currentSet = currentLoggedExercise?.sets[currentSetIndex];

  // Loading state - only show if pending
  if (startWorkoutMutation.isPending) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
        <span className="ml-2 text-primary">Starting workout...</span>
      </div>
    );
  }

  // Error state - only if mutation failed AND we don't have a workout log
  if (startWorkoutMutation.isError && !workoutLog) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <p className="text-error mb-4">Failed to start workout</p>
          <Button onClick={() => router.push("/calendar")}>
            Back to Calendar
          </Button>
        </div>
      </div>
    );
  }

  // If we don't have a workout log yet but mutation succeeded, still show loading
  if (!workoutLog) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
        <span className="ml-2 text-primary">Loading workout...</span>
      </div>
    );
  }

  // Workout complete state - check if all template exercises are done
  if (!currentTemplateExercise || currentExerciseIndex >= templateExercises.length) {
    const handleFinishWorkout = () => {
      if (!workoutLog || !workoutStartTime) return;

      const duration = Math.floor(
        (new Date().getTime() - workoutStartTime.getTime()) / 1000 / 60
      );

      completeWorkoutMutation.mutate(
        {
          workoutLogId: workoutLog.id,
          duration,
        },
        {
          onSuccess: () => {
            router.push("/calendar");
          },
        }
      );
    };

    return (
      <div className="p-4 text-center space-y-4">
        <SectionHeader
          title="Workout Complete! ðŸŽ‰"
          description={`You have completed the ${workoutLog.name} workout.`}
        />
        <Button
          onClick={handleFinishWorkout}
          disabled={completeWorkoutMutation.isPending}
        >
          {completeWorkoutMutation.isPending ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin mr-2" />
              Saving...
            </>
          ) : (
            "Finish Workout"
          )}
        </Button>
      </div>
    );
  }

  const handleSetSubmit = (repsDone: number, weight?: number) => {
    if (!currentSet) return;

    updateSetMutation.mutate(
      {
        setId: currentSet.id,
        reps: repsDone,
        weight: weight || null,
        completed: true,
      },
      {
        onSuccess: (updatedSet) => {
          // Update local state
          setWorkoutLog((prev) => {
            if (!prev) return prev;
            // If the mutation didn't return an updated set, do nothing.
            if (!updatedSet) return prev;

            // Clone exercises and the targeted exercise/sets to avoid mutating state
            const newExercises = [...prev.exercises];
            const currentEx = { ...newExercises[currentExerciseIndex] };
            const newSets = [...currentEx.sets];

            newSets[currentSetIndex] = updatedSet;
            currentEx.sets = newSets;
            newExercises[currentExerciseIndex] = currentEx;

            return { ...prev, exercises: newExercises };
          });

          // Move to next set or exercise
          if (currentSetIndex < currentExercise.sets.length - 1) {
            setCurrentSetIndex(currentSetIndex + 1);
          } else if (currentExerciseIndex < workoutLog.exercises.length - 1) {
            setCurrentExerciseIndex(currentExerciseIndex + 1);
            setCurrentSetIndex(0);
          } else {
            // All exercises complete
            setCurrentExerciseIndex(workoutLog.exercises.length);
          }
        },
      }
    );
  };

  const completedSets = currentExercise.sets.filter((s) => s.completed).length;

  return (
    <div className="p-4 space-y-4 md:space-y-0 md:flex md:gap-6">
      {/* Left Column - Form + Logs */}
      <div className="md:w-1/2 space-y-4">
        <div>
          <h2 className="t3 font-semibold capitalize">
            {currentExercise.exercise.name}
          </h2>
          <p className="text-muted-foreground">
            Exercise {currentExerciseIndex + 1} of {workoutLog.exercises.length}
          </p>
          <p className="text-accent">
            Set {currentSetIndex + 1} of {currentExercise.sets.length} (
            {completedSets} completed)
          </p>
        </div>

        <ExerciseFormItem
          data={{
            exercise: currentExercise.exercise as Exercise,
            sets: currentExercise.sets.length,
            reps: 0, // We'll show actual reps in the dialog
            restTime: 60, // Default rest time
            notes: currentExercise.notes || undefined,
          }}
          mode="view"
          showImage={false}
        />

        {/* Log Set Dialog */}
        <Dialog open={logDialogOpen} onOpenChange={setLogDialogOpen}>
          <DialogTrigger asChild>
            <Button className="w-full" disabled={currentSet?.completed}>
              {currentSet?.completed ? "Set Completed" : "Log Set"}
            </Button>
          </DialogTrigger>
          <DialogContent className="sm:max-w-sm">
            <DialogHeader>
              <DialogTitle>
                Log {currentExercise.exercise.name} â€” Set {currentSetIndex + 1}
              </DialogTitle>
              <p className="text-muted-foreground mt-1">
                Enter reps and weight for this set
              </p>
            </DialogHeader>

            <form
              onSubmit={(e) => {
                e.preventDefault();
                const formData = new FormData(e.currentTarget);
                const reps = parseInt(formData.get("reps") as string);
                const weight = formData.get("weight")
                  ? parseFloat(formData.get("weight") as string)
                  : undefined;
                handleSetSubmit(reps, weight);
                setLogDialogOpen(false);
              }}
              className="space-y-4 mt-4"
            >
              <div>
                <label className="text-sm font-medium">Reps</label>
                <input
                  type="number"
                  name="reps"
                  defaultValue={0}
                  min={0}
                  required
                  className="w-full border p-2 rounded mt-1"
                />
              </div>
              <div>
                <label className="text-sm font-medium">
                  Weight (kg) - Optional
                </label>
                <input
                  type="number"
                  name="weight"
                  step="0.5"
                  min={0}
                  placeholder="0"
                  className="w-full border p-2 rounded mt-1"
                />
              </div>
              <Button
                type="submit"
                className="w-full"
                disabled={updateSetMutation.isPending}
              >
                {updateSetMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    Saving...
                  </>
                ) : (
                  "Save Set"
                )}
              </Button>
            </form>
          </DialogContent>
        </Dialog>

        {/* Logged Sets */}
        <div className="mt-4 space-y-2">
          <h3 className="t5 font-semibold">Completed Sets</h3>
          <div className="space-y-1">
            {workoutLog.exercises.map((ex) => {
              const completedSetsForEx = ex.sets.filter((s) => s.completed);
              if (completedSetsForEx.length === 0) return null;

              return (
                <div key={ex.id} className="text-sm">
                  <p className="font-medium text-primary">{ex.exercise.name}</p>
                  {completedSetsForEx.map((set) => (
                    <p key={set.id} className="text-muted-foreground ml-4">
                      Set {set.setNumber}: {set.reps} reps
                      {set.weight ? ` @ ${set.weight}kg` : ""}
                    </p>
                  ))}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Right Column - Details */}
      <div className="md:w-1/2 space-y-4">
        <ExerciseDetailsDisplay
          exercise={currentExercise.exercise as Exercise}
          showImage={true}
          imageClassName="h-48 md:h-64 rounded-md"
        />
      </div>
    </div>
  );
}
